path   = require 'path'
ake    = require 'cc.ake'

# add node_modules binaries to head of path
do ake.nodeModulePath

task 'web', 'build ccloader.js for use in websites', (options) ->
  ake.assertAll 'coffee -p lib/ccloader/web.coffee > ccloader.js'

task 'clean', 'clean everything generated by build system', (options) ->
  ake.assertAll "rm -rf `grep '^/' .gitignore | sed 's,^/,,'`"

task 'test', 'test ccloader', (options) ->
  # joose-2.1: wget http://joose-js.googlecode.com/files/joose.mini.js -O $@
  invoke 'web'
  ake.assertAll 'ln -sf ../ccloader.js test',
    'cp -n node_modules/joose/joose-all-web.js test/joose.js'
    './bin/ccbaker test/lib/root.js test/lib/joose/root.js > test/lib/packed.js'
    ->
      express = require 'express'
      app     = express.createServer()

      port = process.env.port or 8012

      app.configure () ->
        app.use express.static path.join(process.cwd(), 'test')

      console.log "ccloader test server listening on: #{port}"
      console.log "please go to http://localhost:#{port}/"
      app.listen port

# vim:ts=2 sw=2
